<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <title>设备侧边栏</title>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            overflow-y: auto;
        }
        .sidebar h2 {
            font-size: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #444;
            padding-bottom: 10px;
        }
        .mileage {
            font-weight: bold;
            margin-top: 12px;
            cursor: pointer;
        }
        .stations {
            margin-left: 20px;
            display: none;
        }
        .station {
            margin: 6px 0;
            cursor: pointer;
        }
        .devices {
            margin-left: 20px;
            display: none;
            color: #bdc3c7;
        }
        .device {
            margin: 2px 0;
        }
        .main {
            flex: 1;
            padding: 20px;
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <h2>设备管理</h2>
    <div id="sidebarContent"></div>
</div>

<div class="main">
    <h1>欢迎使用设备侧边栏</h1>
    <p>请点击左侧的观测点查看其设备。</p>
</div>

<script>
    const csvUrl = 'http://localhost:8002/device.csv';  // 修改成你实际CSV文件地址

    function groupForSidebar(devices) {
        const grouped = {};
        devices.forEach(({ 大里程, 小里程, 观测点名称, 设备ID }) => {
            if (!大里程 || !小里程 || !观测点名称 || !设备ID) return; // 跳过无效数据
            const stationLabel = `${观测点名称} (${大里程.toLowerCase()}+${小里程})`;

            if (!grouped[大里程]) grouped[大里程] = {};
            if (!grouped[大里程][stationLabel]) grouped[大里程][stationLabel] = [];

            grouped[大里程][stationLabel].push(设备ID);
        });
        return grouped;
    }

    function renderSidebar(groupedData) {
        const container = document.getElementById('sidebarContent');
        container.innerHTML = '';

        for (const mileage in groupedData) {
            const mileageDiv = document.createElement('div');
            mileageDiv.textContent = `- ${mileage}`;
            mileageDiv.className = 'mileage';

            const stationsWrapper = document.createElement('div');
            stationsWrapper.className = 'stations';

            mileageDiv.onclick = () => {
                stationsWrapper.style.display = stationsWrapper.style.display === 'block' ? 'none' : 'block';
            };

            for (const stationName in groupedData[mileage]) {
                const stationDiv = document.createElement('div');
                stationDiv.textContent = stationName;
                stationDiv.className = 'station';

                const deviceList = document.createElement('div');
                deviceList.className = 'devices';

                stationDiv.onclick = () => {
                    deviceList.style.display = deviceList.style.display === 'block' ? 'none' : 'block';
                };

                groupedData[mileage][stationName].forEach(deviceID => {
                    const deviceDiv = document.createElement('div');
                    deviceDiv.className = 'device';
                    deviceDiv.textContent = deviceID;
                    deviceList.appendChild(deviceDiv);
                });

                stationsWrapper.appendChild(stationDiv);
                stationsWrapper.appendChild(deviceList);
            }

            container.appendChild(mileageDiv);
            container.appendChild(stationsWrapper);
        }
    }

    // 读取CSV并渲染侧边栏
    fetch(csvUrl)
        .then(response => {
            if (!response.ok) throw new Error('网络响应失败');
            return response.text();
        })
        .then(csvText => {
            const results = Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
            });
            const parsedDevices = results.data;
            const grouped = groupForSidebar(parsedDevices);
            renderSidebar(grouped);
        })
        .catch(error => {
            console.error('读取或解析 CSV 出错:', error);
            const container = document.getElementById('sidebarContent');
            container.textContent = '加载设备数据失败，请检查网络或文件格式。';
        });
</script>

</body>
</html>
