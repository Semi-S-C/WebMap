<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>ä¸»é¡µ</title>
    <link
            rel="stylesheet"
            href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
        * {
            box-sizing: border-box;
        }
        body, html {
            margin: 0; padding: 0; height: 100vh; font-family: Arial, sans-serif;
            background-color: #f0f0f0;
        }
        #container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }
        /* å·¦ä¾§å¯¼èˆªæ  */
        #sidebar {
            width: 130px;
            background-color: #0d1b2a;
            color: white;
            transition: width 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        #sidebar.collapsed {
            width: 50px; /* ç»Ÿä¸€æŠ˜å å®½åº¦ */
        }

        #sidebar header {
            padding: 20px;
            font-size: 1.5em;
            text-align: center;
            border-bottom: 1px solid #0d1b2a;
        }

        #sidebar nav {
            flex: 1;
            padding: 5px;
        }

        #sidebar nav a {
            display: flex; /* ä¿è¯å›¾æ ‡å’Œæ–‡å­—æ°´å¹³æ’åˆ— */
            align-items: start;
            gap: 10px;
            padding: 10px 6px;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: background-color 0.3s ease;
        }

        #sidebar nav a:hover {
            background-color: #0d1b2a;
        }

        /* æ–‡å­—éƒ¨åˆ† */
        .text {
            display: inline-block;
            white-space: nowrap;
            transition: opacity 0.3s ease;
        }

        /* æŠ˜å æ—¶æ–‡å­—æ¸éšä¸”ä¸å¯ç‚¹å‡» */
        #sidebar.collapsed .text {
            opacity: 0;
            pointer-events: none;
            width: 0;
            overflow: hidden;
        }

        /* æŠ˜å æ—¶å¯¼èˆªé“¾æ¥æ ·å¼ */
        #sidebar.collapsed nav a {
            justify-content: center;  /* å›¾æ ‡å±…ä¸­ */
            padding: 10px 0;          /* å»æ‰å·¦å³å†…è¾¹è· */
            gap: 0;                   /* å»æ‰å›¾æ ‡å’Œæ–‡å­—é—´è· */
        }





        #toggleBtn {
            background-color: #0d1b2a;
            border: none;
            color: white;
            cursor: pointer;
            padding: 10px;
            font-size: 1.2em;
        }
        #topbar {
            width: 100%;
            height: 60px;
            background: linear-gradient(to right, #0d1b2a, #1b263b);
            color: #00cfff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1em;
            padding: 0 40px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.6);
            font-family: "Microsoft YaHei", sans-serif;
        }

        .left-tabs {
            display: flex;
            gap: 10px;
        }

        .left-tabs span {
            margin-right: 20px;
            padding: 6px 14px;
            background: rgba(0, 128, 255, 0.2);
            border: 1px solid #00cfff;
            border-radius: 8px;
            color: #00cfff;
            font-weight: bold;
            cursor: pointer;
        }

        .left-tabs span:hover {
            background: rgba(0, 128, 255, 0.4);
        }

        .top-title {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.6em;
            font-weight: bold;
            color: #ffffff;
            text-shadow: 0 0 6px #00cfff;
            pointer-events: none; /* å¯é€‰ï¼šé¿å…é®æŒ¡ç‚¹å‡» */
        }

        .right-time {
            position: absolute;
            left: 85%;
            font-size: 1.3em;
            color: #ffffff;
            text-shadow: 0 0 6px #00cfff;
        }
        .leaflet-tooltip.marker-label {
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 4px;
            border: none;
            white-space: nowrap;
        }


        #container {
            padding-top: 60px;
        }
        /* ä¸­é—´åœ°å›¾åŒºåŸŸ */
        #main {
            flex: 1;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* ä½¿ main åŒºåŸŸå…·æœ‰å®šä½çš„èƒ½åŠ› */
        #main {
            position: relative;  /* ä½¿ #zoomFactor ç›¸å¯¹äº #main å®šä½ */
            flex: 1;
            background-color: white;
            display: flex;
            justify-content: center;
            align-items: center;
        }


        /* åœ°å›¾å®¹å™¨ */
        #map {
            width: 100%;
            height: 100%;
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            box-shadow: 0 0 10px #7f8c8d;
        }

        /* 3Dåœ°å›¾ */
        #3Dmap {
            width: 100%;
            height: 100%;
        }
        #zoomFactor {
            position: absolute;
            bottom: 10px;        /* è·ç¦»åº•éƒ¨ 10px */
            left: 10px;          /* è·ç¦»å·¦ä¾§ 10px */
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            font-size: 14px;
            border-radius: 5px;
            z-index: 1000;      /* ç¡®ä¿ç¼©æ”¾ç³»æ•°æ˜¾ç¤ºåœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
        }

        #infoWindow {
            position: absolute; /* å›ºå®šä½ç½® */
            top: 20px;  /* è·ç¦»ä¸Šæ–¹çš„è·ç¦» */
            right: 20px; /* è·ç¦»å³ä¾§çš„è·ç¦» */
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜èƒŒæ™¯ */
            color: white;
            padding: 15px;
            border-radius: 8px;
            width: 220px; /* æ§åˆ¶çª—å£å¤§å° */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6);
            z-index: 1000; /* ç¡®ä¿çª—å£åœ¨æœ€å‰é¢ */
            display: none; /* é»˜è®¤éšè— */
        }

        #infoWindow h4 {
            margin: 0;
            font-size: 16px;
        }

        #infoWindow p {
            font-size: 14px;
            margin-top: 5px;
        }

        /* å¼¹çª—æ ·å¼ */
        #videoModal {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 800px;
        }

        #videoModal video {
            width: 100%;
            height: 100%;
            background: black;
        }

        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        #videoModal button {
            margin-top: 10px;
        }

    </style>
</head>
<body>
<div id="topbar">
    <div class="top-title">åˆ—è½¦è¿è¡Œå®‰å…¨ç¯å¢ƒæ™ºèƒ½ç›‘æ§å¹³å°</div>
    <div class="right-time" id="topTime">2025-07-24 14:18:06</div>
</div>
<div id="container">
    <aside id="sidebar">
        <nav>
            <a href="index.html"><span class="icon">ğŸ–¥ï¸</span><span class="text">é¦–é¡µ</span></a>
            <a href="http://192.168.3.212:10000/#/screen"><span class="icon">ğŸ¥</span><span class="text">è§†é¢‘ç›‘æ§</span></a>
            <a href="../../analysis.html"><span class="icon">ğŸ“ˆ</span><span class="text">æ•°æ®åˆ†æ</span></a>
            <a href="settings.html"><span class="icon">ğŸ“</span><span class="text">æ¶ˆæ¯å®¡æ ¸</span></a>
            <a href="device_manger.html"><span class="icon">ğŸ› ï¸</span><span class="text">è®¾å¤‡ç®¡ç†</span></a>
            <a href="#"><span class="icon">âš™ï¸</span><span class="text">è®¾ç½®</span></a>
            <a href="help.html"><span class="icon">â“</span><span class="text">å¸®åŠ©</span></a>
        </nav>
        <button id="toggleBtn" title="æŠ˜å /å±•å¼€å¯¼èˆªæ ">></button>
    </aside>

    <main id="main">
        <div id="map"></div>
        <!-- å›ºå®šçš„å°çª—å£ -->
        <div id="infoWindow" style="display: none;"> <!-- é»˜è®¤éšè—çª—å£ -->
            <p id="infoContent">æš‚æ— ä¿¡æ¯</p>
        </div>
    </main>
</div>


<!-- å¼¹çª— -->
<div id="overlay"></div>
<div id="videoModal">
    <h3>æ‘„åƒå¤´ç”»é¢</h3>
    <video id="video" controls autoplay muted></video>
    <br />
    <button onclick="closeModal()">å…³é—­</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flv.js@1.6.2/dist/flv.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script src="./railwayData.js"></script>
<script>

    const markers = [];
    const station_markers = [];
    let scale = 1;
    // è®¾å¤‡æ€»è¡¨
    const csvUrl = 'http://192.168.0.19:8002/device.csv';
    //
    const video_device_Url = 'http://192.168.0.19:8002/video_devices_manager.csv';
    let groupedData = {};
    let obs_markers = [];


    // åˆå§‹åŒ–åœ°å›¾ï¼Œè®¾ç½®ä¸­å¿ƒç‚¹å’Œç¼©æ”¾ç­‰çº§
    const map = L.map('map').setView([22.774425, 108.243963], 14); // å—å®å—ç«™




    // åˆ›å»ºå¹¶æ·»åŠ ç¼©æ”¾ç³»æ•°æ˜¾ç¤ºå…ƒç´ åˆ° #main åŒºåŸŸ
    const zoomFactorDiv = document.createElement('div');
    zoomFactorDiv.id = 'zoomFactor';
    document.getElementById('main').appendChild(zoomFactorDiv);  // å°†å…ƒç´ æ·»åŠ åˆ° #main åŒºåŸŸ

    // æ›´æ–°ç¼©æ”¾ç³»æ•°çš„å‡½æ•°
    function updateZoomFactor() {
        const zoomLevel = map.getZoom();  // è·å–å½“å‰çš„ç¼©æ”¾çº§åˆ«
        zoomFactorDiv.textContent = `x${zoomLevel}`;
    }

    // åˆå§‹åŠ è½½æ—¶æ›´æ–°ä¸€æ¬¡ç¼©æ”¾ç³»æ•°
    updateZoomFactor();

    // æ¯æ¬¡åœ°å›¾ç¼©æ”¾ç»“æŸæ—¶æ›´æ–°ç¼©æ”¾ç³»æ•°
    map.on('zoomend', updateZoomFactor);



    // æ·»åŠ åº•å›¾
    // L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    //
    //     maxZoom: 18,
    //     minZoom: 5, // è®¾ç½®æœ€å°ç¼©æ”¾ç­‰çº§
    //     noWrap: true,   // é˜²æ­¢ç“¦ç‰‡è¶…å‡ºåœ°å›¾è¾¹ç•Œæ—¶é‡å¤
    //     attribution: 'Â© å¹¿è¥¿é“ç¿”ç§‘æŠ€',
    //
    // }).addTo(map);


    // æ·»åŠ ç“¦ç‰‡åœ°å›¾
    L.tileLayer(
        // 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',      //  openstreetmap
        // 'http://webst02.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=7&x={x}&y={y}&z={z}',  //  Gaodemap
        'http://192.168.0.19:8002/map/{z}/{x}/{y}.png',   // è°·æ­Œå«æ˜Ÿç¦»çº¿åœ°å›¾

        {
            maxZoom: 18,
            minZoom: 5, // è®¾ç½®æœ€å°ç¼©æ”¾ç­‰çº§
            // tileSize: 512,  // è°ƒæ•´ç“¦ç‰‡çš„å¤§å°
            noWrap: true,   // é˜²æ­¢ç“¦ç‰‡è¶…å‡ºåœ°å›¾è¾¹ç•Œæ—¶é‡å¤
            attribution: 'Â© å¹¿è¥¿é“ç¿”ç§‘æŠ€',
        }
    ).addTo(map);

    // åŠ è½½ GeoJSONï¼ˆå‡è®¾æ–‡ä»¶æ”¾åœ¨åŒç›®å½•ï¼‰
    const customIcon = L.icon({
        iconUrl: 'station3.png',  // å›¾æ ‡çš„ URL åœ°å€
        iconSize: [25, 41],         // å›¾æ ‡å¤§å°
        iconAnchor: [8, 32],       // å›¾æ ‡é”šç‚¹
        popupAnchor: [0, -32],      // å¼¹å‡ºæ¡†ä½ç½®
        shadowUrl: 'marker-shadow.png',    // é˜´å½±ï¼ˆå¯é€‰ï¼‰
        shadowSize: [41, 41],       // é˜´å½±å¤§å°ï¼ˆå¯é€‰ï¼‰
        shadowAnchor: [12, 41]      // é˜´å½±é”šç‚¹ï¼ˆå¯é€‰ï¼‰
    });

    // åŠ è½½ GeoJSON æ•°æ®å¹¶æŒ‡å®šè‡ªå®šä¹‰å›¾æ ‡
    fetch('GoogleRailwayLine.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                pointToLayer: function (feature, latlng) {
                    let currentScale = 1; // åˆå§‹ç¼©æ”¾ç³»æ•°
                    let currentIcon = createScaledIcon(currentScale);
                    // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
                    const marker = L.marker(latlng, { icon: currentIcon });

                    marker.bindTooltip(feature.properties.name || 'æœªçŸ¥', {
                        permanent: false, // é»˜è®¤ä¸æ˜¾ç¤º
                        direction: "top",
                        offset: [0, -20],
                        className: "marker-label"
                    });

                    markers.push(marker); // ä¿å­˜ç”¨äºç¼©æ”¾
                    // åœ¨ç‚¹å‡»æ ‡è®°æ—¶æ›´æ–°å›ºå®šå°çª—å£çš„å†…å®¹å¹¶æ˜¾ç¤º
                    marker.on('click', function() {
                        const infoContent = `
                        <h4>ç«™ç‚¹: ${feature.properties.name || 'æœªçŸ¥'}</h4>
                        <p>é‡Œç¨‹: ${feature.properties.é‡Œç¨‹ || 'æœªçŸ¥'}</p>
                        <p>ç»åº¦: ${latlng.lng}</p>
                        <p>çº¬åº¦: ${latlng.lat}</p>
                    `;

                        // æ˜¾ç¤ºä¿¡æ¯çª—å£
                        document.getElementById('infoContent').innerHTML = infoContent;
                        document.getElementById('infoWindow').style.display = 'block';  // æ˜¾ç¤ºçª—å£
                    });

                    return marker;
                },
                style: {
                    color: '#e8f60d',
                    weight: 6,
                    opacity: 0.3,
                    dashArray: '10,4,2,4'
                }
            }).addTo(map);
        })
        .catch(err => console.error('GeoJSON åŠ è½½å¤±è´¥:', err));


    // ç‚¹å‡»åœ°å›¾å…¶ä»–åœ°æ–¹æ—¶ï¼Œéšè—ä¿¡æ¯çª—å£
    map.on('click', function() {
        document.getElementById('infoWindow').style.display = 'none';  // éšè—çª—å£
    });

    const markerData = [];






    // å¯¼èˆªæ æŠ˜å /å±•å¼€åŠŸèƒ½
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleBtn');
    toggleBtn.addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        toggleBtn.textContent = sidebar.classList.contains('collapsed') ? '<' : '>>';

        refreshMapSize();
    });

    // é¡µé¢å°ºå¯¸å˜åŒ–æ—¶åˆ·æ–°åœ°å›¾å°ºå¯¸
    window.addEventListener('resize', () => {
        map.invalidateSize();
    });

    // åœ°å›¾ç¼©æ”¾å’Œç§»åŠ¨ç»“æŸæ—¶åˆ·æ–°åœ°å›¾å°ºå¯¸
    map.on('zoomend moveend', () => {
        map.invalidateSize();
    });

    map.on('zoomend', () => {
        const zoom = map.getZoom();

        const scale = Math.min(1, Math.pow(zoom / 18, 1));

        const normalIcon = createScaledIcon(scale, 0); // è“è‰²
        const stationIcon = createScaledIcon(scale, 1); // çº¢è‰²

        if (zoom < 13) {
            markers.forEach(marker => map.removeLayer(marker));
            // station_markers.forEach(marker => map.removeLayer(marker));
        } else {
            markers.forEach(marker => {
                if (!map.hasLayer(marker)) map.addLayer(marker);
                marker.setIcon(normalIcon);

                // æ˜¾ç¤ºæˆ–éšè—æ ‡ç­¾
                if (zoom >= 16) {
                    marker.openTooltip();
                } else {
                    marker.closeTooltip();
                }
            });

            station_markers.forEach(marker => {
                if (!map.hasLayer(marker)) map.addLayer(marker);
                // marker.setIcon(stationIcon);

                // æ˜¾ç¤ºæˆ–éšè—æ ‡ç­¾
                if (zoom >= 15) {
                    marker.openTooltip();
                } else {
                    marker.closeTooltip();
                }
            });
        }

        updateZoomFactor(); // æ›´æ–°ç¼©æ”¾æ˜¾ç¤ºï¼ˆä½ å·²æœ‰ï¼‰
    });



    //
    function updateTopTime() {
        const now = new Date();
        const formatted = now.toLocaleString('zh-CN', {
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false
        }).replace(/\//g, '-');
        document.getElementById('topTime').textContent = formatted;
    }
    updateTopTime();
    setInterval(updateTopTime, 1000);

    function createScaledIcon(scale, type) {
        const baseWidth = 25;
        const baseHeight = 41;

        const width = baseWidth * scale;
        const height = baseHeight * scale;

        let iconUrl = 'marker-icon.png'; // é»˜è®¤
        if (type === 1) {
            iconUrl = 'marker-icon-red.png'; // æ¢æˆåˆ«çš„å›¾æ ‡
        }

        return L.icon({
            iconUrl: iconUrl,
            iconSize: [width, height],
            iconAnchor: [width / 2, height],
            popupAnchor: [0, -height],
            shadowUrl: 'marker-shadow.png',
            shadowSize: [width, height]
        });
    }


    // å¤šæ¬¡å»¶è¿Ÿåˆ·æ–°åœ°å›¾å°ºå¯¸å‡½æ•°ï¼Œé¿å…æ˜¾ç¤ºå¼‚å¸¸
    function refreshMapSize(times = 3, delay = 30) {
        if (times <= 0) return;
        map.invalidateSize();
        setTimeout(() => refreshMapSize(times - 1, delay), delay);
    }

    //
    function loadVideoDevice() {
        return fetch(video_device_Url)
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
                return response.text();
            })
            .then(csvText => {
                const results = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                });
                const video_devices = results.data;
                return video_devices;  // â† è¿”å›å‡ºå»

            })
    }

    async function getSerialByNameAndId(name, id) {
        const devices = await loadVideoDevice(); // å¼‚æ­¥åŠ è½½è®¾å¤‡åˆ—è¡¨
        const match = devices.find(
            d => d['è§‚æµ‹ç‚¹åç§°'] === name && d['è®¾å¤‡ID'] === id
        );
        return match ? match.serial : null;
    }

    // âœ… å°è£…åŠ è½½ CSV çš„å‡½æ•°
    function loadDeviceSidebar() {
        return fetch(csvUrl)
            .then(response => {
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”å¤±è´¥');
                return response.text();
            })
            .then(csvText => {
                const results = Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                });

                devices = results.data;
                groupedData = groupForSidebar(devices); // ä½ çš„åŸæœ‰åˆ†ç»„é€»è¾‘

                const placeMap = new Map();

                devices.forEach(({ å¤§é‡Œç¨‹, å°é‡Œç¨‹, è§‚æµ‹ç‚¹åç§°, è®¾å¤‡ID, è®¾å¤‡ç±»å‹ }) => {
                    if (!å¤§é‡Œç¨‹ || !å°é‡Œç¨‹ || !è§‚æµ‹ç‚¹åç§°) return;

                    const bigMileage = å¤§é‡Œç¨‹.toUpperCase();
                    const mileageStr = `${bigMileage}+${å°é‡Œç¨‹}`;
                    const name = `${è§‚æµ‹ç‚¹åç§°}`;
                    const device_id = è®¾å¤‡ID;
                    const device_type = è®¾å¤‡ç±»å‹;

                    const mileage = parseMileage(mileageStr);
                    const coords = getCoordsByMileage(mileage, railwayData);
                    if (!coords) return;

                    if (!placeMap.has(name)) {
                        placeMap.set(name, {
                            name,
                            mileageStr,
                            lon: coords.lon,
                            lat: coords.lat,
                            devices: [] // ğŸ‘ˆ å…³é”®ï¼šæ”¯æŒå¤šä¸ªè®¾å¤‡
                        });
                    }

                    // æ·»åŠ å½“å‰è®¾å¤‡åˆ°è¯¥è§‚æµ‹ç‚¹çš„è®¾å¤‡æ•°ç»„ä¸­
                    placeMap.get(name).devices.push({
                        device_id,
                        device_type
                    });
                });

                const markerData = Array.from(placeMap.values());

                obs_markers = markerData;
                return markerData;
            })
            .catch(error => {
                console.error('è¯»å–æˆ–è§£æ CSV å‡ºé”™:', error);
                document.getElementById('sidebarContent').textContent = 'åŠ è½½è®¾å¤‡æ•°æ®å¤±è´¥';
                return [];
            });
    }



    loadDeviceSidebar().then(data => {
        console.log('obs_markers:', data);
        // è¿™é‡Œç”¨ data æˆ– obs_markers ç»˜åˆ¶æ ‡è®°
        const customIcon2 = L.icon({
            iconUrl: 'marker-icon-red.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowUrl: 'marker-shadow.png',
            shadowSize: [41, 41]
        });

        data.forEach(loc => {
            const latlng = L.latLng(loc.lat, loc.lon);

            // åˆ›å»ºè‡ªå®šä¹‰æ ‡è®°
            const marker = L.marker(latlng, { icon: customIcon2 }).addTo(map);
            station_markers.push(marker);
            //
            marker.bindTooltip(loc.name, {
                permanent: false, // é»˜è®¤ä¸æ˜¾ç¤ºï¼Œç­‰ zoom=16 æ—¶å†æ˜¾ç¤º
                direction: "top",
                offset: [0, -20],
                className: "marker-label"
            });

            // const deviceButtonHtml = `<button onclick="loginAndPlay('${loc.name}', '${loc.device_id}')">${loc.device_id}</button>`;/**/
            const deviceButtonHtml = loc.devices.map(dev =>
                `<button onclick="loginAndPlay('${loc.name}', '${dev.device_id}')">${dev.device_id}</button>`
            ).join(' ');
            console.log(deviceButtonHtml);
            // ç‚¹å‡»æ ‡è®°æ—¶æ›´æ–°é¡µé¢å›ºå®šä¿¡æ¯çª—å£
            marker.on('click', () => {
                const infoContent = `
            <h4>ç«™ç‚¹: ${loc.name || 'æœªçŸ¥'}</h4>
            <p>é‡Œç¨‹: ${loc.mileageStr || 'æœªçŸ¥'}</p>
            <p>ç»åº¦: ${latlng.lng}</p>
            <p>çº¬åº¦: ${latlng.lat}</p>
            <p>è®¾å¤‡: ${deviceButtonHtml}</p>
        `;

                document.getElementById('infoContent').innerHTML = infoContent;
                document.getElementById('infoWindow').style.display = 'block';
            });
        });
    });

    // const obs_markers2 = loadDeviceSidebar();
    // console.log('obs_markers:',obs_markers2)

    function groupForSidebar(devices) {
        const grouped = {};
        devices.forEach(({ å¤§é‡Œç¨‹, å°é‡Œç¨‹, è§‚æµ‹ç‚¹åç§°, è®¾å¤‡ID }) => {
            if (!å¤§é‡Œç¨‹ || !å°é‡Œç¨‹ || !è§‚æµ‹ç‚¹åç§° || !è®¾å¤‡ID) return; // è·³è¿‡æ— æ•ˆæ•°æ®

            // ç»Ÿä¸€å¤§é‡Œç¨‹æ ¼å¼ï¼Œå»æ‰å¤šä½™ç©ºæ ¼ï¼Œè½¬æˆå¤§å†™
            const mileage = å¤§é‡Œç¨‹.trim().toUpperCase();

            // ç»Ÿä¸€å°é‡Œç¨‹å’Œè§‚æµ‹ç‚¹åç§°æ ¼å¼
            const subMileage = å°é‡Œç¨‹.trim();
            const stationName = è§‚æµ‹ç‚¹åç§°.trim();

            // ç»„è£…ç«™ç‚¹æ ‡ç­¾
            const stationLabel = `${stationName} (${mileage}+${subMileage})`;

            if (!grouped[mileage]) grouped[mileage] = {};
            if (!grouped[mileage][stationLabel]) grouped[mileage][stationLabel] = [];

            grouped[mileage][stationLabel].push(è®¾å¤‡ID.trim());
        });
        return grouped;
    }


    function parseMileage(kmStr) {
        const match = /^K(\d+)(?:\+(\d+))?$/.exec(kmStr.trim().toUpperCase()); // ğŸ‘ˆ å¢åŠ  .toUpperCase()
        if (!match) {
            throw new Error(`æ— æ•ˆçš„é‡Œç¨‹æ ¼å¼: ${kmStr}`);
        }
        const km = parseInt(match[1], 10);
        const m = parseInt(match[2] || "0", 10);
        return km * 1000 + m;
    }

    function getCoordsByMileage(mileage, railwayData) {
        let before = null, after = null;

        for (let i = 0; i < railwayData.length; i++) {
            const point = railwayData[i];
            if (point.mileage <= mileage) before = point;
            if (point.mileage >= mileage) {
                after = point;
                break;
            }
        }

        if (!before || !after) return null;

        // æ’å€¼
        if (before.mileage === after.mileage) {
            return { lon: before.lon, lat: before.lat };
        }

        const ratio = (mileage - before.mileage) / (after.mileage - before.mileage);
        const lon = before.lon + ratio * (after.lon - before.lon);
        const lat = before.lat + ratio * (after.lat - before.lat);
        return { lon, lat };
    }


    const serverIP = "192.168.3.212";
    const serverPort = "10000";
    const username = "admin";
    const password = "admin@2024";



    // ç™»å½•é…ç½®ï¼ˆä½ éœ€è¦å®šä¹‰è¿™äº›å˜é‡ï¼šserverIP, serverPort, username, passwordï¼‰
    let cachedToken = null;
    let tokenTimestamp = 0;
    const TOKEN_TTL = 1000 * 60 * 30; // Tokenæœ‰æ•ˆæœŸï¼š30åˆ†é’Ÿï¼ˆä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰

    // ç™»å½•ä¸€æ¬¡ï¼Œç¼“å­˜ token
    async function loginOnce() {
        const now = Date.now();
        if (cachedToken && (now - tokenTimestamp) < TOKEN_TTL) {
            return cachedToken; // æœ‰æ•ˆ tokenï¼Œç›´æ¥è¿”å›
        }

        const passwordMd5 = md5(password); // å¯†ç åŠ å¯†
        const loginResp = await fetch(`http://${serverIP}:${serverPort}/api/v1/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                username,
                password: passwordMd5,
                url_token_only: true
            })
        });

        const loginData = await loginResp.json();
        console.log("ç™»å½•å“åº”ï¼š", loginData);

        if (!loginData.URLToken) {
            alert("ç™»å½•å¤±è´¥ï¼šæœªè·å–åˆ° token");
            throw new Error("ç™»å½•å¤±è´¥");
        }

        cachedToken = loginData.URLToken;
        tokenTimestamp = now;
        return cachedToken;
    }



    async function loginAndPlay(name, id) {
        try {
            console.log('è°ƒç”¨ loginAndPlay()', name, id);

            const token = await loginOnce(); // ç™»å½•ä¸€æ¬¡
            const serial = await getSerialByNameAndId(name, id);

            if (!serial) {
                alert("æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡");
                return;
            }

            console.log("ä½¿ç”¨è¿™ä¸ª serial:", serial);

            const streamResp = await fetch(`http://${serverIP}:${serverPort}/api/v1/stream/start?serial=${serial}&channel=1&token=${token}`);
            const streamData = await streamResp.json();
            console.log("æµåœ°å€å“åº”ï¼š", streamData);

            if (!streamData || !streamData.WS_FLV) {
                alert("æœªè·å–åˆ°æ’­æ”¾åœ°å€");
                return;
            }

            const flvUrl = streamData.WS_FLV + `?token=${token}`;
            openModalWithVideo(flvUrl);

        } catch (error) {
            console.error("æ’­æ”¾è§†é¢‘å¤±è´¥ï¼š", error);
            alert("è§†é¢‘æ’­æ”¾å¤±è´¥ï¼š" + error.message);
        }
    }









    // async function loginAndPlay(name, id) {
    //
    //     console.log('è°ƒç”¨ loginAndPlay()', name, id);
    //     // APiç™»å½•ï¼Œè·å–Token
    //     const passwordMd5 = md5(password); // åŠ¨æ€åŠ å¯†
    //     const loginResp = await fetch(`http://${serverIP}:${serverPort}/api/v1/login`, {
    //         method: "POST",
    //         headers: { "Content-Type": "application/json" },
    //         body: JSON.stringify({
    //             username,
    //             password: passwordMd5,
    //             url_token_only: true
    //         })
    //     });
    //
    //     const loginData = await loginResp.json();
    //     console.log("ç™»å½•å“åº”ï¼š", loginData);
    //
    //     const token = loginData.URLToken;
    //     if (!token) {
    //         alert("ç™»å½•å¤±è´¥ï¼šæœªè·å–åˆ° token");
    //         return;
    //     }
    //
    //     const serial = await getSerialByNameAndId(name, id);
    //     if (serial) {
    //         console.log("ä½¿ç”¨è¿™ä¸ª serial:", serial);
    //         // è·å–æµæ’­æ”¾åœ°å€
    //         const streamResp = await fetch(`http://${serverIP}:${serverPort}/api/v1/stream/start?serial=${serial}&channel=1&token=${token}`);
    //         const streamData = await streamResp.json();
    //         console.log("æµåœ°å€å“åº”ï¼š", streamData);
    //
    //         if (!streamData || !streamData.WS_FLV) {
    //             alert("æœªè·å–åˆ°æ’­æ”¾åœ°å€");
    //             return;
    //         }
    //         const flvUrl = streamData.WS_FLV + `?token=${token}`;
    //         openModalWithVideo(flvUrl);
    //     } else {
    //         alert("æœªæ‰¾åˆ°åŒ¹é…çš„è®¾å¤‡");
    //     }
    //
    // }

    // æ’­æ”¾è§†é¢‘å¹¶æ‰“å¼€å¼¹çª—
    function openModalWithVideo(flvUrl) {
        const videoElement = document.getElementById("video");
        document.getElementById("videoModal").style.display = "block";
        document.getElementById("overlay").style.display = "block";

        if (flvjs.isSupported()) {
            if (window.flvPlayer) {
                window.flvPlayer.destroy();
            }
            window.flvPlayer = flvjs.createPlayer({
                type: "flv",
                url: flvUrl
            });
            window.flvPlayer.attachMediaElement(videoElement);
            window.flvPlayer.load();
            window.flvPlayer.play();
        } else {
            alert("æµè§ˆå™¨ä¸æ”¯æŒ FLV.js");
        }
    }

    // å…³é—­å¼¹çª—å¹¶åœæ­¢æ’­æ”¾
    function closeModal() {
        document.getElementById("videoModal").style.display = "none";
        document.getElementById("overlay").style.display = "none";

        if (window.flvPlayer) {
            window.flvPlayer.destroy();
            window.flvPlayer = null;
        }
    }


</script>
</body>
</html>
